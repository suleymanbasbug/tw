"""
JS Instrumentation Bypass Mod√ºl√º
Twitter'ƒ±n js_instrumentation fingerprint collection'ƒ±nƒ± bypass eder
"""

class JSInstrumentationBypass:
    """Twitter'ƒ±n fingerprint collection'ƒ±nƒ± bypass eden sƒ±nƒ±f"""
    
    def __init__(self, cdp_instance):
        """CDP instance'ƒ±nƒ± al"""
        self.cdp = cdp_instance
    
    def setup_early_injection(self):
        """
        Sayfa y√ºklenmeden √ñNCE fingerprint bypass'ƒ± inject et
        Twitter'ƒ±n js_instrumentation response'unu manip√ºle eder
        """
        print("üîí JS Instrumentation bypass inject ediliyor (early injection)...")
        
        # Twitter'ƒ±n fingerprint collection fonksiyonlarƒ±nƒ± override et
        self.cdp.evaluate("""
            // Twitter fingerprint collection bypass
            (function() {
                // 1. Object.getOwnPropertyDescriptor override
                const originalGetOwnPropertyDescriptor = Object.getOwnPropertyDescriptor;
                Object.getOwnPropertyDescriptor = function(obj, prop) {
                    // Chrome automation kontrollerini bypass et
                    if (prop === 'webdriver' || prop === '$cdc_' || prop === '$chrome_asyncScriptInfo') {
                        return undefined;
                    }
                    return originalGetOwnPropertyDescriptor.apply(this, arguments);
                };
                
                // 2. Function.toString override (anti-override detection)
                const originalToString = Function.prototype.toString;
                Function.prototype.toString = function() {
                    if (this === Object.getOwnPropertyDescriptor) {
                        return 'function getOwnPropertyDescriptor() { [native code] }';
                    }
                    return originalToString.apply(this, arguments);
                };
                
                // 3. Chrome runtime detection bypass
                if (window.chrome && window.chrome.runtime) {
                    // Chrome extension API'yi maskele
                    delete window.chrome.runtime.sendMessage;
                    delete window.chrome.runtime.connect;
                }
                
                // 4. Error stack trace sanitization (bot detection'dan ka√ßƒ±nmak i√ßin)
                const OriginalError = window.Error;
                window.Error = function(...args) {
                    const error = new OriginalError(...args);
                    // Stack trace'den automation i≈üaretlerini temizle
                    if (error.stack) {
                        error.stack = error.stack
                            .replace(/chrome-extension:\\/\\/[a-z]+\\//, '')
                            .replace(/\\$cdc_[a-zA-Z0-9_]+/g, '')
                            .replace(/webdriver/gi, '');
                    }
                    return error;
                };
                window.Error.prototype = OriginalError.prototype;
                
                // 5. Navigator properties sanitization
                const navigatorProps = {
                    webdriver: false,
                    plugins: {
                        length: 3,
                        0: { name: 'Chrome PDF Plugin', filename: 'internal-pdf-viewer' },
                        1: { name: 'Chrome PDF Viewer', filename: 'mhjfbmdgcfjbbpaeojofohoefgiehjai' },
                        2: { name: 'Native Client', filename: 'internal-nacl-plugin' }
                    },
                    languages: ['en-US', 'en'],
                    platform: 'MacIntel',
                    hardwareConcurrency: 8,
                    deviceMemory: 8,
                    maxTouchPoints: 0
                };
                
                for (const [key, value] of Object.entries(navigatorProps)) {
                    try {
                        Object.defineProperty(navigator, key, {
                            get: () => value,
                            configurable: true
                        });
                    } catch (e) {
                        // Bazƒ± propertyler override edilemeyebilir
                    }
                }
                
                // 6. Performance timing fingerprint bypass
                if (window.performance && window.performance.timing) {
                    const originalGetEntries = performance.getEntries;
                    performance.getEntries = function() {
                        const entries = originalGetEntries.apply(this, arguments);
                        // Chrome extension ve webdriver i≈üaretlerini filtrele
                        return entries.filter(entry => {
                            return !entry.name.includes('chrome-extension') && 
                                   !entry.name.includes('webdriver');
                        });
                    };
                }
                
                // 7. Console debug detection bypass
                const originalLog = console.log;
                const originalDebug = console.debug;
                console.log = function(...args) {
                    // Automation loglarƒ±nƒ± filtrele
                    const filtered = args.filter(arg => {
                        if (typeof arg === 'string') {
                            return !arg.includes('webdriver') && !arg.includes('$cdc_');
                        }
                        return true;
                    });
                    return originalLog.apply(console, filtered);
                };
                console.debug = function() {
                    // Debug mesajlarƒ±nƒ± tamamen sustur (fingerprinting √∂nlemi)
                    return;
                };
                
                console.log('‚úÖ JS Instrumentation bypass aktif!');
            })();
        """)
        
        print("‚úÖ JS Instrumentation bypass ba≈üarƒ±yla inject edildi!")
    
    def setup_rf_values_override(self):
        """
        Twitter'ƒ±n topladƒ±ƒüƒ± 'rf' (fingerprint) deƒüerlerini override et
        Bu deƒüerler js_instrumentation response'unda g√∂nderiliyor
        """
        print("üîê RF (fingerprint) deƒüerleri override ediliyor...")
        
        self.cdp.evaluate("""
            // Twitter RF deƒüerleri override
            (function() {
                // RF deƒüerlerini toplayan fonksiyonlarƒ± override et
                const originalFetch = window.fetch;
                window.fetch = function(url, options) {
                    // onboarding/task.json isteƒüini kontrol et
                    if (url.includes('/onboarding/task.json')) {
                        console.log('üéØ onboarding/task.json isteƒüi yakalandƒ±!');
                        
                        // Request body'yi kontrol et
                        if (options && options.body) {
                            try {
                                const body = JSON.parse(options.body);
                                
                                // js_instrumentation kontrol√º
                                if (body.subtask_inputs) {
                                    body.subtask_inputs.forEach(input => {
                                        if (input.sign_up && input.sign_up.js_instrumentation) {
                                            console.log('üîç js_instrumentation bulundu, manip√ºle ediliyor...');
                                            
                                            // Response'u parse et
                                            try {
                                                const jsInst = JSON.parse(input.sign_up.js_instrumentation.response);
                                                
                                                // RF deƒüerlerini ger√ßek√ßi deƒüerlerle deƒüi≈ütir
                                                if (jsInst.rf) {
                                                    // T√ºm rf deƒüerlerini 0 yap (en g√ºvenli y√∂ntem)
                                                    Object.keys(jsInst.rf).forEach(key => {
                                                        jsInst.rf[key] = 0;
                                                    });
                                                    
                                                    console.log('‚úÖ RF deƒüerleri temizlendi (hepsi 0)');
                                                }
                                                
                                                // G√ºncellenmi≈ü response'u geri yaz
                                                input.sign_up.js_instrumentation.response = JSON.stringify(jsInst);
                                            } catch (e) {
                                                console.log('‚ö†Ô∏è js_instrumentation parse hatasƒ±:', e);
                                            }
                                        }
                                    });
                                }
                                
                                // G√ºncellenmi≈ü body'yi options'a geri yaz
                                options.body = JSON.stringify(body);
                                
                            } catch (e) {
                                console.log('‚ö†Ô∏è Request body parse hatasƒ±:', e);
                            }
                        }
                    }
                    
                    // Orijinal fetch'i √ßaƒüƒ±r
                    return originalFetch.apply(this, arguments);
                };
                
                // fetch.toString() override (anti-detection)
                window.fetch.toString = function() {
                    return 'function fetch() { [native code] }';
                };
                
                console.log('‚úÖ RF deƒüerleri override edildi!');
            })();
        """)
        
        print("‚úÖ RF deƒüerleri override ba≈üarƒ±yla kuruldu!")
    
    def setup_complete_bypass(self):
        """T√ºm bypass mekanizmalarƒ±nƒ± √ßalƒ±≈ütƒ±r"""
        print("\nüöÄ JS Instrumentation Complete Bypass Ba≈ülatƒ±lƒ±yor...\n")
        
        # 1. Early injection (en √∂nemli - √∂nce √ßalƒ±≈ümalƒ±)
        self.setup_early_injection()
        
        # 2. RF deƒüerleri override
        self.setup_rf_values_override()
        
        print("\nüéâ JS Instrumentation Complete Bypass Tamamlandƒ±!\n")

