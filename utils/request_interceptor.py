"""
Twitter API ƒ∞stek Override Mod√ºl√º
Twitter'ƒ±n /1.1/onboarding/task.json endpoint'ine giden istekleri yakalar ve js_instrumentation deƒüerlerini deƒüi≈ütirir
"""

import json
import random
import string

class RequestInterceptor:
    """Twitter API isteklerini yakalayƒ±p payload'ƒ± deƒüi≈ütiren sƒ±nƒ±f"""
    
    def __init__(self, driver):
        """Driver instance'ƒ±nƒ± al"""
        self.driver = driver
    
    def generate_fake_js_instrumentation(self):
        """Sahte js_instrumentation response'u √ºret"""
        # Ger√ßek√ßi g√∂r√ºnen ama zararsƒ±z deƒüerler
        fake_rf = {}
        for i in range(10):  # 10 adet fake rf deƒüeri
            key = ''.join(random.choices(string.ascii_lowercase + string.digits, k=64))
            fake_rf[key] = random.randint(0, 100)
        
        # Sahte s deƒüeri (base64 benzeri)
        fake_s = ''.join(random.choices(string.ascii_letters + string.digits + '_-', k=200))
        
        return {
            "rf": fake_rf,
            "s": fake_s
        }
    
    def setup_twitter_request_override(self, custom_js_instrumentation=None, strategy="zero_rf"):
        """
        Twitter API isteklerini yakala ve js_instrumentation deƒüerlerini deƒüi≈ütir
        
        Args:
            custom_js_instrumentation: √ñzel js_instrumentation deƒüeri (dict)
            strategy: Deƒüi≈ütirme stratejisi
                - "zero_rf": RF deƒüerlerini 0 yap
                - "fake": Sahte deƒüerler √ºret
                - "empty": Bo≈ü deƒüerler g√∂nder
                - "custom": custom_js_instrumentation kullan
        """
        print("üéØ Twitter API Request Override kuruluyor...")
        
        # Stratejiye g√∂re js_instrumentation deƒüerini belirle
        if strategy == "custom" and custom_js_instrumentation:
            js_inst_data = custom_js_instrumentation
        elif strategy == "fake":
            js_inst_data = self.generate_fake_js_instrumentation()
        elif strategy == "empty":
            js_inst_data = {"rf": {}, "s": ""}
        else:  # default: zero_rf
            js_inst_data = None  # RF deƒüerlerini 0 yapacaƒüƒ±z
        
        js_override = f"""
        (function() {{
            console.log('üöÄ Twitter API Request Override aktif!');
            
            // Fetch override
            const originalFetch = window.fetch;
            window.fetch = function(input, init) {{
                try {{
                    const url = (typeof input === 'string') ? input : (input && input.url) || '';
                    
                    // Twitter onboarding endpoint'ini yakala
                    if (url.includes('/1.1/onboarding/task.json')) {{
                        console.log('üéØ Twitter onboarding/task.json isteƒüi yakalandƒ±!');
                        
                        init = init || {{}};
                        
                        if (init.body) {{
                            try {{
                                const parsed = JSON.parse(init.body);
                                console.log('üì¶ Orijinal payload alƒ±ndƒ±');
                                
                                // js_instrumentation deƒüerlerini deƒüi≈ütir
                                if (parsed.subtask_inputs) {{
                                    parsed.subtask_inputs.forEach((input, index) => {{
                                        if (input.sign_up && input.sign_up.js_instrumentation) {{
                                            console.log(`üîç js_instrumentation bulundu (index: ${{index}}), manip√ºle ediliyor...`);
                                            
                                            try {{
                                                const jsInst = JSON.parse(input.sign_up.js_instrumentation.response);
                                                console.log('üìä Orijinal js_instrumentation:', jsInst);
                                                
                                                // RF deƒüerlerini MUTLAKA 0 yap
                                                if (jsInst.rf) {{
                                                    const originalRf = {{ ...jsInst.rf }};
                                                    console.log('üî¢ Orijinal RF deƒüerleri:', originalRf);
                                                    
                                                    // T√ºm rf deƒüerlerini 0 yap
                                                    Object.keys(jsInst.rf).forEach(key => {{
                                                        jsInst.rf[key] = 0;
                                                    }});
                                                    
                                                    console.log('‚úÖ RF deƒüerleri 0 yapƒ±ldƒ±:', jsInst.rf);
                                                }}
                                                
                                                // S deƒüerini de temizle
                                                if (jsInst.s) {{
                                                    jsInst.s = "";
                                                    console.log('üßπ S deƒüeri temizlendi');
                                                }}
                                                
                                                // G√ºncellenmi≈ü response'u geri yaz
                                                input.sign_up.js_instrumentation.response = JSON.stringify(jsInst);
                                                console.log('‚úÖ js_instrumentation g√ºncellendi!');
                                                
                                            }} catch(e) {{
                                                console.log('‚ö†Ô∏è js_instrumentation parse hatasƒ±:', e);
                                            }}
                                        }}
                                    }});
                                }}
                                
                                // G√ºncellenmi≈ü body'yi geri yaz
                                init.body = JSON.stringify(parsed);
                                console.log('üì¶ G√ºncellenmi≈ü payload hazƒ±rlandƒ±');
                                
                            }} catch(e) {{
                                console.log('‚ö†Ô∏è Request body parse hatasƒ±:', e);
                            }}
                        }}
                    }}
                }} catch(e) {{ 
                    console.error('üö® fetch-override-error:', e); 
                }}
                
                return originalFetch.call(this, input, init);
            }};

            // XHR override (backup)
            const origOpen = XMLHttpRequest.prototype.open;
            const origSend = XMLHttpRequest.prototype.send;
            
            XMLHttpRequest.prototype.open = function(method, url) {{
                this._url = url;
                this._method = method;
                return origOpen.apply(this, arguments);
            }};
            
            XMLHttpRequest.prototype.send = function(body) {{
                try {{
                    if (this._url && this._url.includes('/1.1/onboarding/task.json')) {{
                        console.log('üéØ XHR ile Twitter onboarding/task.json yakalandƒ±!');
                        
                        if (body) {{
                            try {{
                                const parsed = JSON.parse(body);
                                console.log('üì¶ XHR Orijinal payload alƒ±ndƒ±');
                                
                                // js_instrumentation deƒüerlerini deƒüi≈ütir
                                if (parsed.subtask_inputs) {{
                                    parsed.subtask_inputs.forEach((input, index) => {{
                                        if (input.sign_up && input.sign_up.js_instrumentation) {{
                                            console.log(`üîç XHR js_instrumentation bulundu (index: ${{index}}), manip√ºle ediliyor...`);
                                            
                                            try {{
                                                const jsInst = JSON.parse(input.sign_up.js_instrumentation.response);
                                                console.log('üìä XHR Orijinal js_instrumentation:', jsInst);
                                                
                                                // RF deƒüerlerini MUTLAKA 0 yap
                                                if (jsInst.rf) {{
                                                    Object.keys(jsInst.rf).forEach(key => {{
                                                        jsInst.rf[key] = 0;
                                                    }});
                                                    console.log('‚úÖ XHR RF deƒüerleri 0 yapƒ±ldƒ±:', jsInst.rf);
                                                }}
                                                
                                                // S deƒüerini de temizle
                                                if (jsInst.s) {{
                                                    jsInst.s = "";
                                                    console.log('üßπ XHR S deƒüeri temizlendi');
                                                }}
                                                
                                                // G√ºncellenmi≈ü response'u geri yaz
                                                input.sign_up.js_instrumentation.response = JSON.stringify(jsInst);
                                                console.log('‚úÖ XHR js_instrumentation g√ºncellendi!');
                                                
                                            }} catch(e) {{
                                                console.log('‚ö†Ô∏è XHR js_instrumentation parse hatasƒ±:', e);
                                            }}
                                        }}
                                    }});
                                }}
                                
                                // G√ºncellenmi≈ü body'yi geri yaz
                                body = JSON.stringify(parsed);
                                console.log('üì¶ XHR G√ºncellenmi≈ü payload hazƒ±rlandƒ±');
                                
                            }} catch(e) {{
                                console.log('‚ö†Ô∏è XHR Request body parse hatasƒ±:', e);
                            }}
                        }}
                    }}
                }} catch(e) {{ 
                    console.error('üö® xhr-override-error:', e); 
                }}
                
                return origSend.call(this, body);
            }};

            // Anti-detection: toString override
            window.fetch.toString = function() {{
                return 'function fetch() {{ [native code] }}';
            }};
            
            XMLHttpRequest.prototype.open.toString = function() {{
                return 'function open() {{ [native code] }}';
            }};
            
            XMLHttpRequest.prototype.send.toString = function() {{
                return 'function send() {{ [native code] }}';
            }};
            
            console.log('‚úÖ Twitter API Request Override kuruldu!');
        }})();
        """
        
        # CDP ile sayfa y√ºklenmeden √∂nce inject et
        try:
            self.driver.execute_cdp_cmd("Page.addScriptToEvaluateOnNewDocument", {
                "source": js_override
            })
            print("‚úÖ Twitter API Request Override ba≈üarƒ±yla inject edildi!")
            print(f"üìã Strateji: {strategy}")
            
        except Exception as e:
            print(f"‚ùå Request Override inject hatasƒ±: {e}")
            raise
    
    def _get_js_modification_code(self, js_inst_data, strategy):
        """JS modification kodunu stratejiye g√∂re √ºret"""
        if strategy == "custom" and js_inst_data:
            # Custom deƒüerler kullan
            js_inst_json = json.dumps(js_inst_data)
            return f"""
                                                // Custom js_instrumentation deƒüerleri kullan
                                                const customData = {js_inst_json};
                                                jsInst.rf = customData.rf;
                                                jsInst.s = customData.s;
                                                console.log('üé® Custom js_instrumentation uygulandƒ±:', customData);
            """
        elif strategy == "fake":
            # Sahte deƒüerler √ºret
            return """
                                                // Sahte deƒüerler √ºret
                                                const fakeRf = {};
                                                for (let i = 0; i < 10; i++) {
                                                    const key = Math.random().toString(36).substring(2, 66);
                                                    fakeRf[key] = Math.floor(Math.random() * 100);
                                                }
                                                jsInst.rf = fakeRf;
                                                jsInst.s = Math.random().toString(36).substring(2, 202);
                                                console.log('üé≠ Sahte js_instrumentation uygulandƒ±');
            """
        elif strategy == "empty":
            # Bo≈ü deƒüerler
            return """
                                                // Bo≈ü deƒüerler g√∂nder
                                                jsInst.rf = {};
                                                jsInst.s = "";
                                                console.log('üßπ Bo≈ü js_instrumentation uygulandƒ±');
            """
        else:  # default: zero_rf
            # RF deƒüerlerini 0 yap
            return """
                                                // RF deƒüerlerini 0 yap
                                                if (jsInst.rf) {
                                                    Object.keys(jsInst.rf).forEach(key => {
                                                        jsInst.rf[key] = 0;
                                                    });
                                                    console.log('üî¢ RF deƒüerleri sƒ±fƒ±rlandƒ±');
                                                }
                                                // S deƒüerini de temizle
                                                jsInst.s = "";
                                                console.log('üßπ S deƒüeri temizlendi');
            """
    
    def setup_advanced_interception(self):
        """Geli≈ümi≈ü interception - t√ºm Twitter API endpoint'lerini yakala"""
        print("üî¨ Geli≈ümi≈ü Twitter API Interception kuruluyor...")
        
        js_advanced = """
        (function() {
            console.log('üî¨ Geli≈ümi≈ü Twitter API Interception aktif!');
            
            // T√ºm Twitter API endpoint'lerini yakala
            const twitterEndpoints = [
                '/1.1/onboarding/task.json',
                '/1.1/account/verify_credentials.json',
                '/1.1/account/settings.json',
                '/1.1/users/lookup.json'
            ];
            
            const originalFetch = window.fetch;
            window.fetch = function(input, init) {
                try {
                    const url = (typeof input === 'string') ? input : (input && input.url) || '';
                    
                    // Twitter endpoint'lerini kontrol et
                    const isTwitterEndpoint = twitterEndpoints.some(endpoint => url.includes(endpoint));
                    
                    if (isTwitterEndpoint) {
                        console.log('üéØ Twitter API endpoint yakalandƒ±:', url);
                        
                        // Request logging
                        if (init && init.body) {
                            try {
                                const body = JSON.parse(init.body);
                                console.log('üì¶ Request body:', JSON.stringify(body, null, 2));
                            } catch(e) {
                                console.log('üì¶ Request body (raw):', init.body);
                            }
                        }
                        
                        // Response logging i√ßin promise wrapper
                        const response = originalFetch.call(this, input, init);
                        
                        response.then(res => {
                            console.log('üì° Response status:', res.status);
                            if (res.ok) {
                                res.clone().text().then(text => {
                                    try {
                                        const jsonData = JSON.parse(text);
                                        console.log('üì¶ Response data:', JSON.stringify(jsonData, null, 2));
                                    } catch(e) {
                                        console.log('üì¶ Response data (raw):', text.substring(0, 500));
                                    }
                                });
                            }
                        }).catch(err => {
                            console.log('‚ùå Response error:', err);
                        });
                        
                        return response;
                    }
                } catch(e) { 
                    console.error('üö® advanced-interception-error:', e); 
                }
                
                return originalFetch.call(this, input, init);
            };
            
            console.log('‚úÖ Geli≈ümi≈ü Twitter API Interception kuruldu!');
        })();
        """
        
        try:
            self.driver.execute_cdp_cmd("Page.addScriptToEvaluateOnNewDocument", {
                "source": js_advanced
            })
            print("‚úÖ Geli≈ümi≈ü Twitter API Interception ba≈üarƒ±yla kuruldu!")
            
        except Exception as e:
            print(f"‚ùå Geli≈ümi≈ü Interception kurulum hatasƒ±: {e}")
            raise
